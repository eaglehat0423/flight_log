

{% extends 'base.html' %}

{% load custom_filters %}

{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Add Flight Log</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-group">
      <label for="id_date">Date</label>
      {{ form.date|add_class:"form-control" }}
    </div>
    <div class="form-group">
      <label for="country-select">Departure Country</label>
      <select id="country-select" class="form-control select2">
        <option value="">-- Select Country --</option>
      </select>
    </div>

    <div class="form-group">
      <label for="id_departure">Departure (Airport Code)</label>
      <select name="departure" id="id_departure" class="form-control select2">
        <option value="">-- Select Airport --</option>
      </select>
    </div>

    <div class="form-group mt-3">
        <label for="arrival-country-select">Arrival Country</label>
        <select id="arrival-country-select" class="form-control select2">
            <option value="">-- Select Country --</option>
        </select>
    </div>

    <div class="form-group">
        <label for="id_arrival">Arrival (Airport Code)</label>
        <select name="arrival" id="id_arrival" class="form-control select2">
            <option value="">-- Select Airport --</option>
        </select>
    </div>


    <div class="form-group">
      <label for="id_aircraft_type">Aircraft Type</label>
      <select name="aircraft_type" id="id_aircraft_type" class="form-control select2">
        <option value="">-- Select Aircraft Type --</option>
      </select>
    </div>


    <div class="form-group">
      <label for="id_aircraft_reg">Aircraft Registration</label>
      {{ form.aircraft_reg|add_class:"form-control" }}
    </div>
    <div class="form-group">
      <label for="id_flight_time">Flight Time</label>
      {{ form.flight_time|add_class:"form-control" }}
    </div>
    <div class="form-group">
      <label for="id_flight_type">Flight Type</label>
      {{ form.flight_type|add_class:"form-control" }}
    </div>
    <div class="form-group">
      <label for="id_notes">Notes</label>
      {{ form.notes|add_class:"form-control" }}
    </div>
    <div class="form-group">
      <label for="id_image">Image</label>
      {{ form.image|add_class:"form-control" }}
    </div>
    <button type="submit" class="btn btn-primary mt-2">Save</button>
  </form>
</div>

<script src="{% static 'js/airports.js' %}"></script>
<script src="{% static 'js/aircraft_types.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const airportData = window.airportData;

        const countrySelect = $('#country-select');
        const airportSelect = $('#id_departure');

        const arrivalCountrySelect = $('#arrival-country-select');
        const arrivalAirportSelect = $('#id_arrival');

        const aircraftSelect = $('#id_aircraft_type');

        // Select2 初期化
        $('.select2').select2({
            width: '100%',
            placeholder: '-- Select an option --',
            allowClear: true
        });

        // 出発：国リスト生成
        for (const country in airportData) {
            const option = new Option(country, country);
            countrySelect.append(option.cloneNode(true));
            arrivalCountrySelect.append(option.cloneNode(true));
        }

        // 出発：空港リスト更新
        countrySelect.on('change', function () {
            const selectedCountry = $(this).val();
            airportSelect.empty().append(new Option('-- Select Airport --', ''));
            if (selectedCountry && airportData[selectedCountry]) {
                airportData[selectedCountry].forEach(code => {
                    airportSelect.append(new Option(code, code));
                });
            }
            airportSelect.trigger('change'); // Select2に通知
        });

        // 到着：空港リスト更新
        arrivalCountrySelect.on('change', function () {
            const selectedCountry = $(this).val();
            arrivalAirportSelect.empty().append(new Option('-- Select Airport --', ''));
            if (selectedCountry && airportData[selectedCountry]) {
                airportData[selectedCountry].forEach(code => {
                    arrivalAirportSelect.append(new Option(code, code));
                });
            }
            arrivalAirportSelect.trigger('change'); // Select2に通知
        });

        // 機種リスト追加
        if (window.aircraftTypes) {
            for (const [key, value] of Object.entries(window.aircraftTypes)) {
                aircraftSelect.append(new Option(value, key));
            }
            aircraftSelect.trigger('change'); // Select2に通知
        } else {
            console.warn("aircraftTypes not loaded.");
        }
    });

    
</script>

{% endblock %}
